<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>SINYA USEDPC Dashboard — v8.1 (Fixed)</title>
  <link rel="stylesheet" href="style.css"/>
  <!-- Icons -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <!-- XLSX (for .xlsx import/export when hosted on GitHub Pages) -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>
<body>
  <header class="app-header">
    <h1>SINYA USEDPC Dashboard <span class="tag">v8.1-Fixed</span></h1>
    <div class="header-actions">
      <button id="btnSaveScenario" class="btn primary">儲存情境</button>
      <button id="btnLoadScenario" class="btn">載入情境</button>
      <button id="btnReset" class="btn danger">重置</button>
      <label class="switch">
        <input type="checkbox" id="toggleDiagnostics"/>
        <span class="slider"></span>
      </label>
      <span class="switch-label">診斷模式</span>
    </div>
  </header>

  <main class="container">
    <section class="card">
      <h2>全域參數</h2>
      <div class="grid two">
        <div class="form-row">
          <label>四捨五入單位</label>
          <input id="roundUnit" type="number" step="1" value="10"/>
        </div>
        <div class="form-row">
          <label>四捨五入方式</label>
          <select id="roundMode">
            <option value="nearest">四捨五入</option>
            <option value="ceil">無條件進位</option>
            <option value="floor">無條件捨去</option>
          </select>
        </div>
        <div class="form-row">
          <label>尾數優化</label>
          <select id="tailMode">
            <option value="none">不調整</option>
            <option value="9">尾數9</option>
            <option value="99">尾數99</option>
          </select>
        </div>
        <div class="form-row">
          <label>預設市價調整％（例：0.05）</label>
          <input id="defaultMarketAdj" type="number" step="0.01" value="0.05"/>
        </div>
        <div class="form-row">
          <label>最低毛利率底線（例：0.10）</label>
          <input id="minMarginFloor" type="number" step="0.01" value="0.10"/>
        </div>
        <div class="form-row">
          <label>不得低於市場價 X％（例：-0.05 代表可低 5%）</label>
          <input id="notBelowMarketPct" type="number" step="0.01" value="-0.05"/>
        </div>
      </div>

      <div class="form-row">
        <label>逾期降價階梯（格式：天數/百分比，以逗號分隔）</label>
        <input id="ladderInput" type="text" value="30/-0.05,60/-0.10,90/-0.15"/>
        <small>例如 30/-0.05 表示庫存 ≥30 天降價 5%。系統會套用「符合的最大門檻」。</small>
      </div>
    </section>

    <section class="card">
      <h2>篩選 / 搜尋</h2>
      <div class="grid three">
        <div class="form-row">
          <label>分類</label>
          <select id="filterCategory">
            <option value="">全部</option>
            <option>NB</option>
            <option>DT</option>
            <option>MON</option>
            <option>DIY</option>
            <option>OTH</option>
          </select>
        </div>
        <div class="form-row">
          <label>關鍵字（名稱/備註）</label>
          <input id="searchKeyword" type="text" placeholder="輸入關鍵字…"/>
        </div>
        <div class="form-row align-end">
          <button id="btnApplyFilter" class="btn">套用篩選</button>
          <button id="btnClearFilter" class="btn ghost">清除</button>
        </div>
      </div>
    </section>

    <section class="card">
      <h2>批次設定（僅作用於目前篩選結果）</h2>
      <div class="grid three">
        <div class="form-row">
          <label>批次套用毛利率（空白略過）</label>
          <input id="batchMargin" type="number" step="0.01" placeholder="例如 0.20"/>
        </div>
        <div class="form-row">
          <label>批次套用市價調整％（空白略過）</label>
          <input id="batchMarketAdj" type="number" step="0.01" placeholder="例如 0.05"/>
        </div>
        <div class="form-row align-end">
          <button id="btnBatchApply" class="btn primary">套用到篩選結果</button>
        </div>
      </div>
    </section>

    <section class="card">
      <h2>新增回收品</h2>
      <div class="grid three">
        <div class="form-row">
          <label>名稱</label>
          <input id="newName" type="text" placeholder="例如：ROG NB 15”"/>
        </div>
        <div class="form-row">
          <label>分類</label>
          <select id="newCategory">
            <option>NB</option>
            <option>DT</option>
            <option>MON</option>
            <option>DIY</option>
            <option>OTH</option>
          </select>
        </div>
        <div class="form-row">
          <label>回收日</label>
          <input id="newDate" type="date"/>
        </div>
        <div class="form-row">
          <label>成本</label>
          <input id="newCost" type="number" step="1"/>
        </div>
        <div class="form-row">
          <label>毛利率</label>
          <input id="newMargin" type="number" step="0.01" placeholder="例如 0.20"/>
        </div>
        <div class="form-row">
          <label>市場價（可空）</label>
          <input id="newMarket" type="number" step="1" placeholder="可空"/>
        </div>
        <div class="form-row">
          <label>單品市價調整％（可空）</label>
          <input id="newMarketAdj" type="number" step="0.01" placeholder="可空"/>
        </div>
        <div class="form-row checkbox-row">
          <label class="checkbox">
            <input id="newRepair" type="checkbox"/> 有維修紀錄
          </label>
        </div>
        <div class="form-row" id="repairNoteRow" style="display:none;">
          <label>維修備註</label>
          <input id="newRepairNote" type="text" placeholder="維修內容、零件…"/>
        </div>
        <div class="form-row span-full align-end">
          <button id="btnAdd" class="btn success">加入清單</button>
        </div>
      </div>
    </section>

    <section class="card">
      <h2>回收清單</h2>
      <div class="table-wrap">
        <table id="itemsTable">
          <thead>
            <tr>
              <th>#</th>
              <th>名稱</th>
              <th>分類</th>
              <th>回收日</th>
              <th>庫存天數</th>
              <th>成本</th>
              <th>毛利率</th>
              <th>市場價</th>
              <th>市價調整％</th>
              <th>最終售價</th>
              <th>毛利額</th>
              <th>維修</th>
              <th>備註</th>
              <th>操作</th>
            </tr>
          </thead>
          <tbody></tbody>
          <tfoot>
            <tr>
              <td colspan="9" class="right">二手總價：</td>
              <td id="sumPrice" class="mono">0</td>
              <td id="sumProfit" class="mono">0</td>
              <td colspan="3"></td>
            </tr>
          </tfoot>
        </table>
      </div>
    </section>

    <section class="card">
      <h2>匯入 / 匯出</h2>
      <div class="grid three">
        <div class="form-row">
          <button id="btnExportJSON" class="btn">匯出 JSON</button>
          <button id="btnExportCSV" class="btn">匯出 CSV</button>
          <button id="btnExportXLSX" class="btn">匯出 XLSX</button>
        </div>
        <div class="form-row">
          <label class="file">
            <input id="fileImport" type="file" accept=".json,.csv,.xlsx"/>
            <span>選擇檔案以匯入（JSON / CSV / XLSX）</span>
          </label>
        </div>
        <div class="form-row align-end">
          <button id="btnImport" class="btn primary">開始匯入</button>
        </div>
      </div>
    </section>

    <section class="card subtle">
      <h3>v8.1-Fixed 變更摘要</h3>
      <ul>
        <li>修正計算順序：毛利 → 階梯 → 最低毛利率 → 市價下限 → 四捨五入 → 尾數；尾數不再打破約束，必要時回補。</li>
        <li>新增診斷模式：顯示每列中間值（市價調整後、初步售價、降價後、底線校正後、下限校正後、四捨五入後、尾數後）。</li>
        <li>批次套用僅作用於目前篩選結果（明確顯示）。</li>
        <li>「有維修紀錄」連動顯示備註欄位；表格可即時編輯並存回。</li>
        <li>支援 JSON / CSV / XLSX 匯出入；XLSX 需在 GitHub Pages 上使用（透過 CDN）。</li>
        <li>LocalStorage 情境儲存/載入。</li>
        <li>更佳的響應式排版與鍵盤可用性。</li>
      </ul>
    </section>

  </main>

  <footer class="app-footer">
    <span>© 2025 SINYA (demo). Built for GitHub Pages deployment.</span>
    <a href="README.md">README</a>
  </footer>

  <script src="script.js"></script>
</body>
</html>
