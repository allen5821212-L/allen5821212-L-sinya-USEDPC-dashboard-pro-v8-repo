<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>SINYA USEDPC Dashboard — 8.5 Pro / Purchase-Date Enhanced</title>
  <link rel="stylesheet" href="style.css"/>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>
<body>
  <header class="app-header">
    <h1>SINYA USEDPC Dashboard — 8.5 Pro / Purchase-Date Enhanced <span class="tag">calendar-month + purchase-date</span></h1>
    <div class="header-actions">
      <label class="switch">
        <input type="checkbox" id="toggleDiagnostics"/>
        <span class="slider"></span>
      </label>
      <span class="switch-label">診斷模式</span>
    </div>
  </header>

  <main class="container">
    <section class="card">
      <h2>全域參數</h2>
      <div class="grid three">
        <div class="form-row">
          <label>四捨五入單位</label>
          <input id="roundUnit" type="number" step="1" value="10" min="1"/>
          <small class="muted">建議 ≥ 1；輸入非數值將回退為 1。</small>
        </div>
        <div class="form-row">
          <label>四捨五入方式</label>
          <select id="roundMode">
            <option value="nearest">四捨五入</option>
            <option value="ceil">無條件進位</option>
            <option value="floor">無條件捨去</option>
          </select>
        </div>
        <div class="form-row">
          <label>尾數優化</label>
          <select id="tailMode">
            <option value="none">不調整</option>
            <option value="9">尾數9</option>
            <option value="99">尾數99</option>
          </select>
        </div>
        <div class="form-row">
          <label>預設市價調整％（例：0.05）</label>
          <input id="defaultMarketAdj" type="number" step="0.01" value="0.05"/>
        </div>
        <div class="form-row">
          <label>最低毛利率底線（例：0.10）</label>
          <input id="minMarginFloor" type="number" step="0.01" value="0.10" min="0"/>
        </div>
        <div class="form-row">
          <label>不得低於市場價 X％（例：-0.05 可低5%）</label>
          <input id="notBelowMarketPct" type="number" step="0.01" value="-0.05"/>
        </div>
      </div>

      <div class="grid two">
        <div class="form-row">
          <label>逾期降價階梯（格式：天數/百分比，以逗號分隔）</label>
          <input id="ladderInput" type="text" value="30/-0.05,60/-0.10,90/-0.15"/>
          <small>例如 30/-0.05 表示庫存 ≥30 天降價 5%。系統會套用「符合的最大門檻」。</small>
        </div>
        <div class="form-row">
          <label>係數月序基準</label>
          <select id="coeffBasis">
            <option value="purchase">依「購買日(原購)」</option>
            <option value="recycle">依「回收日(入庫)」</option>
          </select>
          <small class="muted">估價情境多採「購買日」，庫存售價可採「回收日」。</small>
        </div>
      </div>

      <div class="generator">
        <h3>按月自動生成階梯</h3>
        <div class="grid three">
          <div class="form-row">
            <label>起始月</label>
            <input id="genStartMonth" type="number" min="1" max="36" value="3"/>
          </div>
          <div class="form-row">
            <label>結束月</label>
            <input id="genEndMonth" type="number" min="1" max="36" value="12"/>
          </div>
          <div class="form-row">
            <label>每月調整％（負數=降價，例如 -0.05）</label>
            <input id="genPerMonthPct" type="number" step="0.01" value="-0.05"/>
          </div>
        </div>
        <div class="form-row align-end">
          <button id="btnGenLadder" class="btn success">生成 → 套用到階梯</button>
        </div>
      </div>
    </section>

    <section class="card">
      <h2>每月回收係數（1–18 月）</h2>
      <div class="form-row"><label class="checkbox"><input type="checkbox" id="cumulativeMode"/> 啟用「每月以累積降幅」模式（當月係數 × 前月累乘）</label></div>
      <p class="muted">說明：依「<b>係數月序基準</b>」來決定第 N 月。當勾選累積模式時，會用 1→當月的係數累乘。</p>
      <div class="grid three" id="coeffGrid"></div>
      <div class="grid two" style="margin-top:8px">
        <div class="form-row">
          <label>快速貼上 1–18 月係數（以逗號或空白分隔）</label>
          <textarea id="coeffPaste" rows="3" placeholder="例如：1 1 0.99 0.98 0.97 0.96 0.95 0.94 0.93 0.92 0.91 0.90 0.89 0.88 0.87 0.86 0.85 0.84"></textarea>
        </div>
        <div class="form-row align-end">
          <button id="btnCoeffPasteGlobal" class="btn primary">套用到全域</button>
          <button id="btnCoeffPasteItems" class="btn">套用到目前篩選的單品（覆寫）</button>
          <button id="btnCoeffReset" class="btn ghost">全部重置為 1.00</button>
        </div>
      </div>
    </section>

    <section class="card">
      <h2>新增回收品</h2>
      <div class="grid three">
        <div class="form-row">
          <label>名稱</label>
          <input id="newName" type="text" placeholder="例如：ROG NB 15”"/>
        </div>
        <div class="form-row">
          <label>分類</label>
          <select id="newCategory">
            <option>NB</option>
            <option>DT</option>
            <option>MON</option>
            <option>DIY</option>
            <option>OTH</option>
          </select>
        </div>
        <div class="form-row">
          <label>購買日（原購）</label>
          <input id="newPurchaseDate" type="date"/>
        </div>
        <div class="form-row">
          <label>回收日（入庫）</label>
          <input id="newDate" type="date"/>
        </div>
        <div class="form-row">
          <label>成本</label>
          <input id="newCost" type="number" step="1"/>
        </div>
        <div class="form-row">
          <label>毛利率</label>
          <input id="newMargin" type="number" step="0.01" placeholder="例如 0.20"/>
        </div>
        <div class="form-row">
          <label>市場價（可空）</label>
          <input id="newMarket" type="number" step="1" placeholder="可空"/>
        </div>
        <div class="form-row">
          <label>單品市價調整％（可空）</label>
          <input id="newMarketAdj" type="number" step="0.01" placeholder="可空"/>
        </div>
        <div class="form-row checkbox-row">
          <label class="checkbox"><input id="newRepair" type="checkbox"/> 有維修紀錄</label>
        </div>
        <div class="form-row" id="repairNoteRow" style="display:none;">
          <label>維修備註</label>
          <input id="newRepairNote" type="text" placeholder="維修內容、零件…"/>
        </div>
        <div class="form-row span-full align-end">
          <button id="btnAdd" class="btn success">加入清單</button>
        </div>
      </div>
    </section>

    <section class="card">
      <h2>回收清單</h2>
      <div class="table-wrap">
        <table id="itemsTable">
          <thead>
            <tr>
              <th>#</th>
              <th>名稱</th>
              <th>分類</th>
              <th>購買日</th>
              <th>回收日</th>
              <th>庫存天數</th>
              <th>第N月(購買)</th>
              <th>第N月(回收)</th>
              <th>成本</th>
              <th>毛利率</th>
              <th>市場價</th>
              <th>市價調整％</th>
              <th>最終售價</th>
              <th>毛利額</th>
              <th>維修</th>
              <th>備註</th>
              <th>月係數覆寫（1–18，用逗號/空白）</th>
              <th>操作</th>
            </tr>
          </thead>
          <tbody></tbody>
          <tfoot>
            <tr>
              <td colspan="12" class="right">二手總價：</td>
              <td id="sumPrice" class="mono">0</td>
              <td id="sumProfit" class="mono">0</td>
              <td colspan="4"></td>
            </tr>
          </tfoot>
        </table>
      </div>
    </section>

    <section class="card subtle">
      <h3>8.5 Pro / Purchase-Date Enhanced 變更摘要</h3>
      <ul>
        <li>新增欄位：<b>購買日(原購)</b>；全域設定可選擇係數月序「依購買日」或「依回收日」。</li>
        <li>修正：每月回收係數採 <b>曆法月</b> 計算（同月日未到不算新的一個月）。</li>
        <li>診斷：顯示購買與回收兩種月序，便於核對。</li>
      </ul>
    </section>
  </main>

  <footer class="app-footer">
    <span>© 2025 SINYA (demo). Built for GitHub Pages deployment.</span>
    <a href="README.md">README</a>
  </footer>

  <script src="script.js"></script>
</body>
</html>
